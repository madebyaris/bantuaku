services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    ports:
      - "8080:8080"
    environment:
      - DATABASE_URL=postgres://bantuaku:bantuaku_secret@db:5432/bantuaku_dev?sslmode=disable
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=dev-jwt-secret-change-in-production
      - KOLOSAL_API_KEY=${KOLOSAL_API_KEY:-}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}
      - OPENROUTER_MODEL_CHAT=${OPENROUTER_MODEL_CHAT:-openai/gpt-4o-mini}
      - LOG_LEVEL=debug
      - PORT=8080
      - CORS_ORIGIN=http://localhost:3000,http://localhost:3001
      - FORECASTING_SERVICE_URL=http://forecasting:8000
    volumes:
      - ./backend:/app
      - /app/tmp
      - /app/vendor
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      forecasting:
        condition: service_started

  frontend:
    image: node:20-alpine
    working_dir: /app
    ports:
      - "3000:3000"
    environment:
      - VITE_API_URL=http://backend:8080
      - CHOKIDAR_USEPOLLING=true
      - DOCKER=true
    depends_on:
      - backend
    volumes:
      - ./frontend:/app
      - /app/node_modules
    command: sh -c "npm install && npm run dev -- --host"
    stdin_open: true
    tty: true

  admin:
    image: node:20-alpine
    working_dir: /app
    ports:
      - "3001:3001"
    environment:
      - VITE_API_URL=http://backend:8080
      - CHOKIDAR_USEPOLLING=true
      - DOCKER=true
    depends_on:
      - backend
    volumes:
      - ./admin:/app
      - /app/node_modules
    command: sh -c "npm install && npm run dev -- --host --port 3001"
    stdin_open: true
    tty: true

  db:
    image: pgvector/pgvector:pg18
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=bantuaku_dev
      - POSTGRES_USER=bantuaku
      - POSTGRES_PASSWORD=bantuaku_secret
    volumes:
      - db_data:/var/lib/postgresql
      - ./database/migrations:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U bantuaku -d bantuaku_dev"]
      interval: 5s
      timeout: 3s
      retries: 5

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  forecasting:
    build:
      context: ./services/forecasting
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgres://bantuaku:bantuaku_secret@db:5432/bantuaku_dev?sslmode=disable
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health').read()"]
      interval: 10s
      timeout: 5s
      retries: 5

  # pgAdmin - Development only (not for production)
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: pgadmin-1
    profiles:
      - dev
    ports:
      - "5050:80"
    environment:
      - PGADMIN_DEFAULT_EMAIL=admin@bantuaku.com
      - PGADMIN_DEFAULT_PASSWORD=admin
      - PGADMIN_CONFIG_SERVER_MODE=False
      - PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED=False
    volumes:
      - pgadmin_data:/var/lib/pgadmin
      - ./docker/pgadmin/servers.json:/pgadmin4/servers.json:ro
      - ./docker/pgadmin/pgpass:/tmp/pgpass_src:ro
    entrypoint: /bin/sh -c "cp /tmp/pgpass_src /var/lib/pgadmin/pgpass && chmod 600 /var/lib/pgadmin/pgpass && /entrypoint.sh"
    depends_on:
      db:
        condition: service_healthy

volumes:
  db_data:
  pgadmin_data:
